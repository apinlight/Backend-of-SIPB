# Production Deployment Checklist - Manual Pengadaan Fix

## Issue Summary
Manual Pengadaan feature was failing with SQL errors:
1. **Missing column**: `tipe` column didn't exist in `tb_gudang` table
2. **Composite key bug**: Empty column names in WHERE clauses when updating existing records for non-admin users

## Required Backend Changes

### 1. Database Migration
Run the new migration to add the missing `tipe` column:

```bash
# On production server:
cd /path/to/sipb-backend
git pull origin main
php artisan migrate --force
```

**Migration file**: `2025_10_26_000000_add_tipe_to_gudang_table.php`
- Adds `tipe` column (string, default: 'biasa') to `tb_gudang`

### 2. Model Fix
The `Gudang` model has been updated to properly handle composite keys:
- Changed `protected $primaryKey = null` to `protected $primaryKey = 'unique_id'`
- Added `setKeysForSaveQuery()` method to properly handle both keys in WHERE clauses
- This fix is included in the latest commit and will be deployed with git pull

## Verification Steps

After deploying:

1. **Test with ADMIN001 (existing behavior - should still work)**:
   ```
   POST /api/v1/gudang
   {
     "unique_id": "ADMIN001",
     "id_barang": "BRG-001",
     "jumlah_barang": 5,
     "keterangan": "Test manual"
   }
   ```

2. **Test with regular users (USR1001, USR1002 - previously failing)**:
   ```
   POST /api/v1/gudang
   {
     "unique_id": "USR1001",
     "id_barang": "BRG-002",
     "jumlah_barang": 10,
     "keterangan": "Test Budi"
   }
   ```

Expected: Both should succeed (201 Created or 200 OK)

## Root Cause Analysis

### Why it worked for ADMIN001 but not USR1001/USR1002?

The issue was in the `GudangService::createOrUpdate()` method using `firstOrNew()`:
- When a record **doesn't exist** (first time add), `firstOrNew()` creates a new model → works fine
- When a record **exists** (updating stock), `firstOrNew()` loads existing model → tries to save/update

The bug in `Gudang` model (`primaryKey = null`) caused Eloquent to generate invalid SQL:
```sql
-- Invalid SQL generated by broken model:
UPDATE `tb_gudang` SET ... WHERE `` = 'USR1001' AND `` = 'USR1001'
                                  ^^                    ^^
                          (empty column names!)
```

**Why ADMIN001 worked initially**: If you were always adding new items (not updating), `firstOrNew()` would create new records without hitting the update path.

**Why USR1001/USR1002 failed**: If those users already had stock records in the database, `firstOrNew()` would try to update existing records, triggering the buggy WHERE clause generation.

## Files Changed

Backend:
- `database/migrations/2025_10_26_000000_add_tipe_to_gudang_table.php` (new)
- `app/Models/Gudang.php` (modified)

Frontend: No changes needed for this fix.

## Deployment Command Summary

```bash
# SSH into production
ssh user@sipb.crulxproject.com

# Navigate to backend
cd /var/www/sipb-backend  # or wherever your backend is

# Pull latest changes
git pull origin main

# Run migrations
php artisan migrate --force

# Clear caches (optional but recommended)
php artisan config:clear
php artisan cache:clear
php artisan route:clear

# Restart services if using queue workers
php artisan queue:restart  # if applicable
```

## Rollback Plan

If issues arise:

```bash
# Rollback migration
php artisan migrate:rollback --step=1

# Revert code
git checkout HEAD~2  # go back 2 commits
composer dump-autoload
```

---

**Date**: October 26, 2025  
**Issue**: Manual Pengadaan SQL errors  
**Status**: ✅ Fixed locally, pending production deployment
